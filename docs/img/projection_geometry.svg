<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 650" width="900" height="650">
  <defs>
    <style>
      .label { font-family: Arial, sans-serif; font-size: 13px; fill: black; }
      .title { font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; fill: black; }
      .subtitle { font-family: Arial, sans-serif; font-size: 14px; fill: #555; }
      .annotation { font-family: Arial, sans-serif; font-size: 12px; fill: #333; }
      .step-number { font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; fill: white; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="black" />
    </marker>
    <marker id="arrowhead-blue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#0066cc" />
    </marker>
    <marker id="arrowhead-darkblue" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#003399" />
    </marker>
    <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#00aa00" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" class="title">How InnerPiSSA Measures Steering Success</text>
  <text x="450" y="50" text-anchor="middle" class="subtitle">Projection geometry: comparing reference model vs steered policy model</text>
  
  <!-- Main diagram area -->
  <g id="main-diagram">
    <!-- Coordinate axes (light gray) -->
    <line x1="100" y1="450" x2="750" y2="450" stroke="#ccc" stroke-width="1"/>
    <line x1="100" y1="450" x2="100" y2="100" stroke="#ccc" stroke-width="1"/>
    <text x="425" y="470" text-anchor="middle" class="annotation" fill="#999">Hidden state dimension 1</text>
    <text x="70" y="275" text-anchor="middle" class="annotation" fill="#999" transform="rotate(-90 70 275)">Hidden state dimension 2</text>
    
    <!-- Origin marker -->
    <circle cx="100" cy="450" r="4" fill="black"/>
    <text x="85" y="470" class="annotation" font-size="11">(0,0)</text>
    
    <!-- STEP 1: Preference direction from reference model -->
    <g id="step1">
      <circle cx="60" cy="90" r="18" fill="#666"/>
      <text x="60" y="97" text-anchor="middle" class="step-number">1</text>
      
      <!-- The main preference direction arrow -->
      <line x1="100" y1="450" x2="650" y2="150" stroke="black" stroke-width="4" marker-end="url(#arrowhead)"/>
      <text x="680" y="145" class="label" font-weight="bold">pref_dir</text>
      <text x="680" y="162" class="annotation">("honest" direction</text>
      <text x="680" y="177" class="annotation">from reference model)</text>
      
      <!-- Explanation box for step 1 -->
      <rect x="60" y="110" width="280" height="55" fill="#f5f5f5" stroke="#666" stroke-width="2" rx="5"/>
      <text x="200" y="128" text-anchor="middle" class="annotation" font-weight="bold">Extract preference direction</text>
      <text x="200" y="145" text-anchor="middle" class="annotation">Take difference between honest &amp; dishonest</text>
      <text x="200" y="160" text-anchor="middle" class="annotation">activations from reference model → PCA</text>
    </g>
    
    <!-- STEP 2: Reference model activations -->
    <g id="step2">
      <circle cx="60" cy="210" r="18" fill="#0066cc"/>
      <text x="60" y="217" text-anchor="middle" class="step-number">2</text>
      
      <!-- Reference activation point -->
      <circle cx="420" cy="290" r="10" fill="#66b3ff" stroke="#0066cc" stroke-width="3"/>
      <text x="360" y="285" class="label" fill="#0066cc" font-weight="bold">ref_cho</text>
      <text x="360" y="302" class="annotation" fill="#0066cc">(honest answer)</text>
      
      <!-- Projection line from ref_cho perpendicular to pref_dir -->
      <line x1="420" y1="290" x2="484" y2="226" stroke="#0066cc" stroke-width="2" stroke-dasharray="6,4"/>
      
      <!-- Projection point on pref_dir -->
      <circle cx="484" cy="226" r="6" fill="#0066cc" stroke="#003399" stroke-width="2"/>
      
      <!-- Projection length indicator -->
      <line x1="100" y1="450" x2="484" y2="226" stroke="#0066cc" stroke-width="3" opacity="0.3"/>
      <path d="M 290,340 Q 320,310 350,330" stroke="#0066cc" stroke-width="2" fill="none" marker-end="url(#arrowhead-blue)"/>
      <text x="260" y="345" class="annotation" fill="#0066cc" font-weight="bold">proj_ref</text>
      
      <!-- Explanation box for step 2 -->
      <rect x="60" y="230" width="280" height="55" fill="#e6f3ff" stroke="#0066cc" stroke-width="2" rx="5"/>
      <text x="200" y="248" text-anchor="middle" class="annotation" font-weight="bold">Measure reference projection</text>
      <text x="200" y="265" text-anchor="middle" class="annotation">How far does reference model's honest</text>
      <text x="200" y="280" text-anchor="middle" class="annotation">activation project along pref_dir?</text>
    </g>
    
    <!-- STEP 3: Steered policy model activations -->
    <g id="step3">
      <circle cx="60" cy="330" r="18" fill="#003399"/>
      <text x="60" y="337" text-anchor="middle" class="step-number">3</text>
      
      <!-- Policy activation point (steered further in honest direction) -->
      <circle cx="550" cy="200" r="12" fill="#0033aa" stroke="#001166" stroke-width="3"/>
      <text x="605" y="200" class="label" fill="#003399" font-weight="bold">policy_cho</text>
      <text x="605" y="217" class="annotation" fill="#003399">(steered honest)</text>
      
      <!-- Projection line from policy_cho perpendicular to pref_dir -->
      <line x1="550" y1="200" x2="590" y2="160" stroke="#003399" stroke-width="2" stroke-dasharray="6,4"/>
      
      <!-- Projection point on pref_dir -->
      <circle cx="590" cy="160" r="6" fill="#003399" stroke="#001166" stroke-width="2"/>
      
      <!-- Projection length indicator -->
      <line x1="100" y1="450" x2="590" y2="160" stroke="#003399" stroke-width="3" opacity="0.3"/>
      <path d="M 340,300 Q 400,250 450,260" stroke="#003399" stroke-width="2" fill="none" marker-end="url(#arrowhead-darkblue)"/>
      <text x="380" y="255" class="annotation" fill="#003399" font-weight="bold">proj_pi</text>
      
      <!-- Explanation box for step 3 -->
      <rect x="60" y="350" width="280" height="70" fill="#e6f0ff" stroke="#003399" stroke-width="2" rx="5"/>
      <text x="200" y="368" text-anchor="middle" class="annotation" font-weight="bold">Measure steered projection</text>
      <text x="200" y="385" text-anchor="middle" class="annotation">How far does our steered policy model's</text>
      <text x="200" y="402" text-anchor="middle" class="annotation">activation project? If InnerPiSSA works,</text>
      <text x="200" y="419" text-anchor="middle" class="annotation">this should be LONGER (more honest)</text>
    </g>
    
    <!-- STEP 4: The difference (what we optimize) -->
    <g id="step4">
      <circle cx="60" cy="460" r="18" fill="#00aa00"/>
      <text x="60" y="467" text-anchor="middle" class="step-number">4</text>
      
      <!-- Bracket showing the difference along pref_dir -->
      <line x1="494" y1="221" x2="494" y2="155" stroke="#00aa00" stroke-width="4"/>
      <line x1="489" y1="221" x2="499" y2="221" stroke="#00aa00" stroke-width="3"/>
      <line x1="589" y1="155" x2="499" y2="155" stroke="#00aa00" stroke-width="3"/>
      <polygon points="585,150 595,155 585,160" fill="#00aa00"/>
      
      <text x="520" y="192" class="label" fill="#00aa00" font-weight="bold" font-size="15">proj_diff</text>
      
      <!-- Explanation box for step 4 -->
      <rect x="60" y="480" width="280" height="70" fill="#e6ffe6" stroke="#00aa00" stroke-width="2" rx="5"/>
      <text x="200" y="498" text-anchor="middle" class="annotation" font-weight="bold">Calculate improvement</text>
      <text x="200" y="515" text-anchor="middle" class="annotation" font-weight="bold">proj_diff = proj_pi - proj_ref</text>
      <text x="200" y="532" text-anchor="middle" class="annotation">This is what the loss function sees!</text>
      <text x="200" y="549" text-anchor="middle" class="annotation">Bigger = better steering (up to quality limit)</text>
    </g>
  </g>
  
  <!-- Summary box -->
  <rect x="380" y="480" width="500" height="150" fill="#fffef0" stroke="#ff8800" stroke-width="3" rx="8"/>
  <text x="630" y="505" text-anchor="middle" class="label" font-weight="bold" font-size="15" fill="#cc6600">The Key Idea</text>
  
  <text x="630" y="530" text-anchor="middle" class="annotation">1. We extract the "honesty direction" from a reference model</text>
  <text x="630" y="548" text-anchor="middle" class="annotation">2. We measure how far the reference projects along this direction</text>
  <text x="630" y="566" text-anchor="middle" class="annotation">3. We measure how far our steered model projects</text>
  <text x="630" y="584" text-anchor="middle" class="annotation">4. <tspan font-weight="bold" fill="#00aa00">The difference (proj_diff) tells us if steering worked!</tspan></text>
  
  <text x="630" y="610" text-anchor="middle" class="annotation" font-style="italic">Loss = -softplus(proj_diff) → pushes proj_diff higher</text>
  <text x="630" y="625" text-anchor="middle" class="annotation" font-style="italic">(while coherence constraint keeps output quality good)</text>
</svg>
